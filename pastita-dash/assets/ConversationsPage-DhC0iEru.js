import{j as e}from"./vendor-charts-o9Lo7m6Z.js";import{r as n}from"./vendor-react-C2HNIXra.js";import{d as Ne,am as c,an as ve,R as l,Z as o,ao as we,$ as be,a0 as Ce,X as i,ap as ke,E as Se,aq as _e,w as T,ar as y,i as ee,a4 as N,z as se,af as F,a7 as ze,ah as ae,al as Re,as as te,at as re,h as Te,ag as A,W as Fe,a6 as Ae,aa as ne,au as le,p as v}from"./feature-automation-CLWK1V5x.js";import{u as Ie}from"./index-DQDVHdIA.js";import{g as S,i as Me}from"./vendor-utils-DaXQUBrP.js";import"./vendor-ui-B9rDAafI.js";import"./vendor-mui-DKuE-Kg_.js";const Be=()=>{const{selectedAccount:w}=Ie(),{storeSlug:I,storeId:M}=Ne(),[d,g]=n.useState([]),[_,de]=n.useState({}),[ie,$]=n.useState(!0),[f,E]=n.useState(null),[r,h]=n.useState(null),[z,P]=n.useState([]),[R,O]=n.useState(""),[b,L]=n.useState(""),[ce,D]=n.useState(!1),[oe,H]=n.useState(!1),[B,V]=n.useState(!1),[p,X]=n.useState(null),[x,q]=n.useState(null),[j,G]=n.useState("");n.useEffect(()=>{xe()},[w,I,M]);const xe=async()=>{$(!0);try{const s={};w&&(s.account=w.id);const a=await c.getConversations(s);g(a.results);const t={};for(const m of a.results)try{const k=await ve.getByCustomer(m.phone_number,I||M||void 0);k.length>0&&(t[m.id]=k)}catch{}de(t)}catch(s){l.error(o(s))}finally{$(!1)}},C=n.useMemo(()=>{const s={};return d.forEach(a=>{s[a.status]=(s[a.status]||0)+1}),s},[d]),Q=n.useMemo(()=>{const s={};return d.forEach(a=>{s[a.mode]=(s[a.mode]||0)+1}),s},[d]),U=n.useMemo(()=>{let s=d;if(p&&(s=s.filter(a=>a.status===p)),x&&(s=s.filter(a=>a.mode===x)),j){const a=j.toLowerCase();s=s.filter(t=>t.contact_name?.toLowerCase().includes(a)||t.phone_number.includes(a)||t.tags.some(m=>m.toLowerCase().includes(a)))}return s},[d,p,x,j]),me=s=>{const a=_[s]||[];if(a.length===0)return null;const t=a.filter(u=>["pending","processing"].includes(u.status)).length,m=a.filter(u=>u.payment_status==="paid"||["paid","confirmed"].includes(u.status)).length,k=a.filter(u=>["shipped","out_for_delivery"].includes(u.status)).length,fe=a.filter(u=>["delivered","completed"].includes(u.status)).length;return{total:a.length,pending:t,paid:m,shipped:k,delivered:fe}},W=async(s,a)=>{try{const t=a==="human"?await c.switchToHuman(s.id):await c.switchToAuto(s.id);g(d.map(m=>m.id===t.id?t:m)),l.success(`Modo alterado para ${a==="human"?"humano":"automático"}`)}catch(t){l.error(o(t))}},Z=async s=>{try{const a=await c.closeConversation(s.id);g(d.map(t=>t.id===a.id?a:t)),l.success("Conversa fechada")}catch(a){l.error(o(a))}},J=async s=>{try{const a=await c.resolveConversation(s.id);g(d.map(t=>t.id===a.id?a:t)),l.success("Conversa resolvida")}catch(a){l.error(o(a))}},K=async s=>{try{const a=await c.reopenConversation(s.id);g(d.map(t=>t.id===a.id?a:t)),l.success("Conversa reaberta")}catch(a){l.error(o(a))}},he=async s=>{try{const a=await c.getNotes(s.id);P(a),E(s)}catch(a){l.error(o(a))}},ue=async()=>{if(!(!f||!R.trim())){D(!0);try{const s=await c.addNote(f.id,R);P([s,...z]),O(""),l.success("Nota adicionada")}catch(s){l.error(o(s))}finally{D(!1)}}},ge=async()=>{if(!(!r||!b.trim())){H(!0);try{const s=await c.addTag(r.id,b.trim());g(d.map(a=>a.id===s.id?s:a)),h(s),L(""),l.success("Tag adicionada")}catch(s){l.error(o(s))}finally{H(!1)}}},pe=async s=>{if(r)try{const a=await c.removeTag(r.id,s);g(d.map(t=>t.id===a.id?a:t)),h(a),l.success("Tag removida")}catch(a){l.error(o(a))}},Y=async s=>{V(!0);try{const a=await le.exportConversations({format:s,status:p||void 0,mode:x||void 0,account_id:w?.id}),t=new Date().toISOString().slice(0,10);le.downloadBlob(a,`conversas-${t}.${s}`),l.success("Exporta??o conclu?da!")}catch(a){l.error(o(a))}finally{V(!1)}},je=[{value:null,label:"Todas",count:d.length},...Object.entries(we).map(([s,a])=>({value:s,label:a.label,count:C[s]||0}))],ye=[{key:"contact",header:"Contato",render:s=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center",children:e.jsx(y,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:s.contact_name||"Sem nome"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-zinc-400",children:s.phone_number})]})]})},{key:"status",header:"Status",render:s=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(te,{status:s.status}),e.jsx(re,{mode:s.mode})]})},{key:"orders",header:"Pedidos",render:s=>{const a=me(s.id);return a?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[a.pending>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-300 text-xs rounded-full",children:[a.pending," pendente(s)"]}),a.paid>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 text-xs rounded-full",children:[a.paid," pago(s)"]}),a.shipped>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-teal-100 text-teal-700 text-xs rounded-full",children:[a.shipped," enviado(s)"]}),a.delivered>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full",children:[a.delivered," entregue(s)"]})]}):e.jsx("span",{className:"text-sm text-gray-400",children:"Sem pedidos"})}},{key:"tags",header:"Tags",render:s=>e.jsx("div",{className:"flex flex-wrap gap-1",children:s.tags.length===0?e.jsx("span",{className:"text-sm text-gray-400",children:"-"}):e.jsxs(e.Fragment,{children:[s.tags.slice(0,3).map(a=>e.jsx("span",{className:"px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-zinc-400 text-xs rounded-full",children:a},a)),s.tags.length>3&&e.jsxs("span",{className:"text-xs text-gray-400",children:["+",s.tags.length-3]})]})})},{key:"last_message_at",header:"Última Atividade",render:s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-zinc-400",children:s.last_message_at?Me(new Date(s.last_message_at),{addSuffix:!0,locale:v}):"-"})]})},{key:"actions",header:"Ações",render:s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{size:"sm",variant:s.mode==="human"?"secondary":"primary",leftIcon:s.mode==="human"?e.jsx(T,{className:"w-4 h-4"}):e.jsx(y,{className:"w-4 h-4"}),onClick:a=>{a.stopPropagation(),W(s,s.mode==="human"?"auto":"human")},children:s.mode==="human"?"Auto":"Humano"}),e.jsx(i,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),he(s)},children:"Notas"}),s.status==="open"||s.status==="pending"?e.jsxs(e.Fragment,{children:[e.jsx(i,{size:"sm",variant:"ghost",leftIcon:e.jsx(F,{className:"w-4 h-4"}),onClick:a=>{a.stopPropagation(),J(s)},children:"Resolver"}),e.jsx(i,{size:"sm",variant:"secondary",leftIcon:e.jsx(A,{className:"w-4 h-4"}),onClick:a=>{a.stopPropagation(),Z(s)},children:"Fechar"})]}):e.jsx(i,{size:"sm",variant:"ghost",leftIcon:e.jsx(ne,{className:"w-4 h-4"}),onClick:a=>{a.stopPropagation(),K(s)},children:"Reabrir"})]})}];return ie?e.jsx(be,{}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(Ce,{title:"Conversas",subtitle:`${U.length} de ${d.length} conversa(s)`,actions:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(i,{variant:"secondary",onClick:()=>Y("csv"),isLoading:B,children:"Exportar CSV"}),e.jsx(i,{variant:"secondary",onClick:()=>Y("xlsx"),isLoading:B,children:"Exportar XLSX"})]})}),e.jsx(ke,{tabs:je,value:p,onChange:X}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Se,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar por nome, telefone ou tag...",value:j,onChange:s=>G(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-zinc-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]}),e.jsx("div",{className:"flex gap-2",children:Object.entries(_e).map(([s,a])=>e.jsxs("button",{onClick:()=>q(x===s?null:s),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${x===s?"bg-gray-900 text-white":"bg-white text-gray-700 border border-gray-200 hover:bg-gray-50"}`,children:[s==="auto"&&e.jsx(T,{className:"w-4 h-4"}),s==="human"&&e.jsx(y,{className:"w-4 h-4"}),s==="hybrid"&&e.jsx(ee,{className:"w-4 h-4"}),a.label,e.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-xs ${x===s?"bg-white/20":"bg-gray-100"}`,children:Q[s]||0})]},s))}),(p||x||j)&&e.jsx(i,{variant:"ghost",onClick:()=>{X(null),q(null),G("")},children:"Limpar"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(N,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/40 rounded-lg",children:e.jsx(ee,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:C.open||0}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-zinc-400",children:"Abertas"})]})]})}),e.jsx(N,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-yellow-100 dark:bg-yellow-900/40 rounded-lg",children:e.jsx(se,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:C.pending||0}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-zinc-400",children:"Pendentes"})]})]})}),e.jsx(N,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/40 rounded-lg",children:e.jsx(F,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:C.resolved||0}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-zinc-400",children:"Resolvidas"})]})]})}),e.jsx(N,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 dark:bg-purple-900/40 rounded-lg",children:e.jsx(y,{className:"w-6 h-6 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:Q.human||0}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-zinc-400",children:"Atendimento Humano"})]})]})})]}),e.jsx(N,{noPadding:!0,children:e.jsx(ze,{columns:ye,data:U,keyExtractor:s=>s.id,onRowClick:s=>h(s),emptyMessage:p||x||j?"Nenhuma conversa encontrada com os filtros aplicados":"Nenhuma conversa encontrada"})}),e.jsx(ae,{isOpen:!!f,onClose:()=>E(null),title:`Notas - ${f?.contact_name||f?.phone_number}`,size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{placeholder:"Adicionar uma nota...",rows:3,value:R,onChange:s=>O(s.target.value)}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(i,{size:"sm",onClick:ue,isLoading:ce,children:"Adicionar Nota"})})]}),e.jsx("div",{className:"border-t pt-4 space-y-3 max-h-96 overflow-y-auto",children:z.length===0?e.jsx("p",{className:"text-center text-gray-500 dark:text-zinc-400 py-4",children:"Nenhuma nota"}):z.map(s=>e.jsxs("div",{className:"bg-gray-50 dark:bg-black rounded-lg p-3",children:[e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:s.content}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-zinc-400 mt-2",children:S(new Date(s.created_at),"dd/MM/yyyy HH:mm",{locale:v})})]},s.id))})]})}),e.jsx(ae,{isOpen:!!r,onClose:()=>h(null),title:"Detalhes da Conversa",size:"lg",children:r&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 dark:bg-black rounded-lg",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-primary-100 flex items-center justify-center",children:e.jsx(y,{className:"w-8 h-8 text-primary-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:r.contact_name||"Sem nome"}),e.jsx("p",{className:"text-gray-600 dark:text-zinc-400",children:r.phone_number})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(te,{status:r.status,size:"md"}),e.jsx(re,{mode:r.mode,size:"md"})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 dark:text-zinc-300 mb-2 flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),"Tags"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.tags.map(s=>e.jsxs("span",{className:"px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-zinc-300 text-sm rounded-full flex items-center gap-2",children:[s,e.jsx("button",{onClick:()=>pe(s),className:"text-gray-400 hover:text-red-500",children:e.jsx(A,{className:"w-4 h-4"})})]},s)),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{placeholder:"Nova tag...",value:b,onChange:s=>L(s.target.value),className:"w-32"}),e.jsx(i,{size:"sm",variant:"secondary",leftIcon:e.jsx(Ae,{className:"w-4 h-4"}),onClick:ge,isLoading:oe,disabled:!b.trim(),children:"Adicionar"})]})]})]}),_[r.id]&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-zinc-300 mb-2",children:"Pedidos do Cliente"}),e.jsx("div",{className:"space-y-2",children:_[r.id].map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-black rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:["#",s.order_number]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-zinc-400",children:S(new Date(s.created_at),"dd/MM/yyyy",{locale:v})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:["R$ ",s.total.toLocaleString("pt-BR",{minimumFractionDigits:2})]}),e.jsx("span",{className:`px-2 py-0.5 text-xs rounded-full ${s.status==="paid"?"bg-green-100 text-green-700":s.status==="shipped"?"bg-teal-100 text-teal-700":s.status==="delivered"?"bg-indigo-100 text-indigo-700":s.status==="cancelled"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:s.status==="pending"?"Pendente":s.status==="processing"?"Processando Pagamento":s.status==="paid"?"Pago":s.status==="shipped"?"Enviado":s.status==="delivered"?"Entregue":s.status==="cancelled"?"Cancelado":s.status})]})]},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-zinc-400",children:"Criada em"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:S(new Date(r.created_at),"dd/MM/yyyy HH:mm",{locale:v})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500 dark:text-zinc-400",children:"Última mensagem"}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:r.last_message_at?S(new Date(r.last_message_at),"dd/MM/yyyy HH:mm",{locale:v}):"-"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsxs(i,{variant:r.mode==="human"?"secondary":"primary",leftIcon:r.mode==="human"?e.jsx(T,{className:"w-4 h-4"}):e.jsx(y,{className:"w-4 h-4"}),onClick:()=>{W(r,r.mode==="human"?"auto":"human"),h(null)},children:["Mudar para ",r.mode==="human"?"Automático":"Humano"]}),r.status==="open"||r.status==="pending"?e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"secondary",leftIcon:e.jsx(F,{className:"w-4 h-4"}),onClick:()=>{J(r),h(null)},children:"Resolver"}),e.jsx(i,{variant:"danger",leftIcon:e.jsx(A,{className:"w-4 h-4"}),onClick:()=>{Z(r),h(null)},children:"Fechar"})]}):e.jsx(i,{variant:"primary",leftIcon:e.jsx(ne,{className:"w-4 h-4"}),onClick:()=>{K(r),h(null)},children:"Reabrir"})]})]})})]})};export{Be as ConversationsPage};
