import{j as e}from"./vendor-charts-o9Lo7m6Z.js";import{r as d,L as W}from"./vendor-react-C2HNIXra.js";import{a as R,l as z,R as y,a5 as D,a4 as r,aU as A,X as f,aa as L,az as B,i as C,z as I,ag as N,b1 as S,af as $,a$ as P,a6 as M,j as T,U,Z as G}from"./feature-automation-CLWK1V5x.js";import{C as V}from"./ChatWindow-Bg8a9ZTJ.js";import{u as X}from"./index-DQDVHdIA.js";import"./vendor-utils-DaXQUBrP.js";import"./vendor-ui-B9rDAafI.js";import"./vendor-mui-DKuE-Kg_.js";const p=({ok:t,label:c})=>e.jsxs("div",{className:"flex items-center gap-2",children:[t?e.jsx($,{className:"w-5 h-5 text-green-500"}):e.jsx(N,{className:"w-5 h-5 text-red-500"}),e.jsx("span",{className:t?"text-green-700 dark:text-green-400":"text-red-700 dark:text-red-400",children:c})]}),ee=()=>{const[t,c]=d.useState(null),[x,g]=d.useState(!0),[o,m]=d.useState(!1),[l,n]=d.useState(!1),i=d.useCallback(async()=>{try{const s=await R.get("/webhooks/whatsapp/debug/");c(s.data)}catch(s){z.error("Failed to fetch diagnostics",s),y.error("Erro ao carregar diagnóstico")}finally{g(!1)}},[]);d.useEffect(()=>{i()},[i]),d.useEffect(()=>{if(l){const s=setInterval(i,5e3);return()=>clearInterval(s)}},[l,i]);const b=async s=>{m(!0);try{const _=(await R.post("/webhooks/whatsapp/debug/",{action:s,limit:50})).data.results;y.success(`Reprocessado: ${_.processed} sucesso, ${_.failed} falhas`),i()}catch(k){z.error("Failed to reprocess events",k),y.error("Erro ao reprocessar eventos")}finally{m(!1)}};if(x)return e.jsx(D,{});if(!t)return e.jsx("div",{className:"p-6",children:e.jsxs(r,{className:"p-6 text-center",children:[e.jsx(A,{className:"w-12 h-12 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-2",children:"Erro ao carregar diagnóstico"}),e.jsx(f,{onClick:i,children:"Tentar novamente"})]})});const{diagnosis:a,stats:h,accounts:E,recent_events:F,recent_inbound_messages:v,failed_events:w}=t,u=[a.has_active_accounts,a.celery_connected,!a.has_failed_events,a.receiving_webhooks,a.receiving_messages].filter(Boolean).length,j=u>=4?"healthy":u>=2?"warning":"critical";return e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Diagnóstico de Webhooks WhatsApp"}),e.jsx("p",{className:"text-gray-500 dark:text-zinc-400",children:"Monitore o recebimento de mensagens em tempo real"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 dark:text-zinc-400",children:[e.jsx("input",{type:"checkbox",checked:l,onChange:s=>n(s.target.checked),className:"rounded border-gray-300"}),"Auto-refresh (5s)"]}),e.jsx(f,{variant:"secondary",onClick:i,children:e.jsx(L,{className:"w-5 h-5"})})]})]}),e.jsx(r,{className:`p-6 border-l-4 ${j==="healthy"?"border-l-green-500 bg-green-50 dark:bg-green-900/20":j==="warning"?"border-l-yellow-500 bg-yellow-50 dark:bg-yellow-900/20":"border-l-red-500 bg-red-50 dark:bg-red-900/20"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Status do Sistema"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsx(p,{ok:a.has_active_accounts,label:"Contas ativas"}),e.jsx(p,{ok:a.celery_connected,label:"Celery conectado"}),e.jsx(p,{ok:!a.has_failed_events,label:"Sem eventos falhos"}),e.jsx(p,{ok:a.receiving_webhooks,label:"Recebendo webhooks"}),e.jsx(p,{ok:a.receiving_messages,label:"Recebendo mensagens"}),e.jsx(p,{ok:!a.has_pending_events,label:"Sem eventos pendentes"})]})]}),e.jsxs("div",{className:`text-4xl font-bold ${j==="healthy"?"text-green-600":j==="warning"?"text-yellow-600":"text-red-600"}`,children:[u,"/5"]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"w-8 h-8 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:h.webhook_events.last_hour}),e.jsx("p",{className:"text-sm text-gray-500",children:"Webhooks (última hora)"})]})]})}),e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(C,{className:"w-8 h-8 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:h.messages.inbound_last_hour}),e.jsx("p",{className:"text-sm text-gray-500",children:"Mensagens (última hora)"})]})]})}),e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(I,{className:"w-8 h-8 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:h.webhook_events.pending}),e.jsx("p",{className:"text-sm text-gray-500",children:"Eventos pendentes"})]})]})}),e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{className:"w-8 h-8 text-red-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:h.webhook_events.failed}),e.jsx("p",{className:"text-sm text-gray-500",children:"Eventos com falha"})]})]})})]}),e.jsxs(r,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Contas WhatsApp"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Nome"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Telefone"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Phone Number ID"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Ativo"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:E.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:s.name}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-zinc-400",children:s.phone_number}),e.jsx("td",{className:"px-4 py-2 text-sm font-mono text-gray-600 dark:text-zinc-400",children:s.phone_number_id}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(S,{variant:s.status==="active"?"success":"warning",children:s.status})}),e.jsx("td",{className:"px-4 py-2",children:s.is_active?e.jsx($,{className:"w-5 h-5 text-green-500"}):e.jsx(N,{className:"w-5 h-5 text-red-500"})})]},s.id))})]})})]}),(a.has_pending_events||a.has_failed_events)&&e.jsxs(r,{className:"p-6 bg-yellow-50 dark:bg-yellow-900/20",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Ações de Recuperação"}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[a.has_pending_events&&e.jsx(f,{onClick:()=>b("reprocess_pending"),disabled:o,children:o?"Processando...":`Processar ${h.webhook_events.pending} eventos pendentes`}),a.has_failed_events&&e.jsx(f,{variant:"secondary",onClick:()=>b("reprocess_failed"),disabled:o,children:o?"Processando...":`Reprocessar ${h.webhook_events.failed} eventos com falha`})]})]}),w.length>0&&e.jsxs(r,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Eventos com Falha (últimos 5)"}),e.jsx("div",{className:"space-y-3",children:w.map(s=>e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/20 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[s.event_type," - Tentativas: ",s.retry_count]}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 mt-1",children:s.error_message||"Erro desconhecido"})]}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleString("pt-BR")})]})},s.id))})]}),e.jsxs(r,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Eventos Recentes (últimos 20)"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Tipo"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Data"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Erro"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:F.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:s.event_type}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(S,{variant:s.processing_status==="completed"?"success":s.processing_status==="failed"?"danger":s.processing_status==="pending"?"warning":"info",children:s.processing_status})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-zinc-400",children:new Date(s.created_at).toLocaleString("pt-BR")}),e.jsx("td",{className:"px-4 py-2 text-sm text-red-600 dark:text-red-400 max-w-xs truncate",children:s.error_message||"-"})]},s.id))})]})})]}),e.jsxs(r,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Mensagens Recebidas (últimas 10)"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"De"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Tipo"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Mensagem"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Data"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:[v.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:s.from_number}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-zinc-400",children:s.message_type}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-zinc-400 max-w-xs truncate",children:s.text_body||"-"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-zinc-400",children:new Date(s.created_at).toLocaleString("pt-BR")})]},s.id)),v.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-8 text-center text-gray-500",children:"Nenhuma mensagem recebida recentemente"})})]})]})})]}),e.jsx(r,{className:"p-4 bg-gray-50 dark:bg-zinc-900",children:e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 dark:text-zinc-400",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsxs("span",{children:["Servidor: ",new Date(t.server_time).toLocaleString("pt-BR")]}),e.jsx("span",{children:"|"}),e.jsxs("span",{children:["Celery: ",t.celery_status]})]})})]})},se=()=>{const{accounts:t,selectedAccount:c,setSelectedAccount:x,setAccounts:g}=X(),[o,m]=d.useState(!0);return d.useEffect(()=>{(async()=>{if(t.length===0){m(!0);try{const n=await U.getAccounts();g(n.results||[]),n.results?.length>0&&!c&&x(n.results[0])}catch(n){y.error(G(n))}finally{m(!1)}}else m(!1),!c&&t.length>0&&x(t[0])})()},[t,c,g,x]),o?e.jsx("div",{className:"flex items-center justify-center h-[calc(100vh-8rem)]",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"}),e.jsx("p",{className:"text-gray-500 dark:text-zinc-400",children:"Carregando contas WhatsApp..."})]})}):t.length===0?e.jsx("div",{className:"flex items-center justify-center h-[calc(100vh-8rem)]",children:e.jsxs(r,{className:"max-w-md text-center p-8",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center",children:e.jsx(A,{className:"w-8 h-8 text-amber-600 dark:text-amber-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-2",children:"Nenhuma conta WhatsApp configurada"}),e.jsx("p",{className:"text-gray-600 dark:text-zinc-400 mb-6",children:"Você precisa configurar uma conta do WhatsApp Business para começar a enviar e receber mensagens."}),e.jsxs(W,{to:"/accounts/new",className:"inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(M,{className:"w-5 h-5"}),"Adicionar Conta WhatsApp"]})]})}):e.jsxs("div",{className:"h-[calc(100vh-8rem)] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/30 rounded-lg",children:e.jsx(T,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"WhatsApp Chat"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-zinc-400",children:"Gerencie suas conversas em tempo real"})]})]}),t.length>1&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-500 dark:text-zinc-400",children:"Conta:"}),e.jsx("select",{value:c?.id||"",onChange:l=>{const n=t.find(i=>i.id===l.target.value);n&&x(n)},className:"px-3 py-1.5 text-sm bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent",children:t.map(l=>e.jsxs("option",{value:l.id,children:[l.phone_number," - ",l.name||"WhatsApp Business"]},l.id))})]})]}),c?e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(V,{accountId:c.id,accountName:c.name||c.phone_number})}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-zinc-950",children:e.jsxs("div",{className:"text-center",children:[e.jsx(C,{className:"w-16 h-16 mx-auto text-gray-300 dark:text-zinc-700 mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-zinc-400",children:"Selecione uma conta para começar"})]})})]})};export{ee as WebhookDiagnosticsPage,se as WhatsAppChatPage};
