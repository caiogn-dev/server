import{j as e}from"./vendor-charts-o9Lo7m6Z.js";import{r,R as de}from"./vendor-react-C2HNIXra.js";import{i as O,B as a,C as L,T as i,s as H,c as B,F as ue,I as xe,S as he,M as me,v as j,w as oe,x as fe,h as I,y as pe,z as ge,E as je,t as ee,H as ye,D as ve,k as A,P as be,A as ie,J as _e,b as k,K as se,f as te,N as Ce,G as ae,O as Se,Q as we,R as re,U as ne,V as ke,W as Ie,X as Ae,Y as Ee,Z as ze}from"./vendor-mui-DKuE-Kg_.js";import{r as V,d as De}from"./feature-reports-B4FqePvs.js";import{d as Me,a as We}from"./Search-BWkx6N48.js";import{bq as d}from"./feature-automation-CLWK1V5x.js";import"./vendor-utils-DaXQUBrP.js";import"./vendor-ui-B9rDAafI.js";var Q={},Re=O;Object.defineProperty(Q,"__esModule",{value:!0});var R=Q.default=void 0,Te=Re(V()),Le=e;R=Q.default=(0,Te.default)((0,Le.jsx)("path",{d:"M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2M6 9h12v2H6zm8 5H6v-2h8zm4-6H6V6h12z"}),"Chat");var U={},Be=O;Object.defineProperty(U,"__esModule",{value:!0});var T=U.default=void 0,Pe=Be(V()),qe=e;T=U.default=(0,Pe.default)((0,qe.jsx)("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"}),"SmartToy");var K={},$e=O;Object.defineProperty(K,"__esModule",{value:!0});var N=K.default=void 0,Fe=$e(V()),He=e;N=K.default=(0,Fe.default)((0,He.jsx)("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"}),"Person");function Xe(){const[E,P]=r.useState([]),[p,b]=r.useState(""),[z,x]=r.useState([]),[n,q]=r.useState(null),[_,C]=r.useState([]),[u,y]=r.useState(""),[l,c]=r.useState(!0),[D,S]=r.useState(!1),[h,v]=r.useState(!1),[m,$]=r.useState(""),[M,g]=r.useState(null),w=r.useRef(null);r.useEffect(()=>{f()},[]),r.useEffect(()=>{p&&G()},[p]),r.useEffect(()=>{n&&le()},[n]),r.useEffect(()=>{t()},[_]);const t=()=>{w.current?.scrollIntoView({behavior:"smooth"})},f=async()=>{try{const o=(await d.getAccounts()).data||[];P(o),o.length>0&&b(o[0].id)}catch(s){console.error("Error loading accounts:",s),g("Erro ao carregar contas do Messenger")}finally{c(!1)}},G=async()=>{if(p)try{c(!0);const s=await d.getConversations(p);x(s.data||[]),g(null)}catch(s){console.error("Error loading conversations:",s),g("Erro ao carregar conversas")}finally{c(!1)}},le=async()=>{if(n)try{S(!0);const s=await d.getMessages(n.id);C(s.data||[]);try{await d.markAsRead(n.id)}catch{}}catch(s){console.error("Error loading messages:",s)}finally{S(!1)}},J=async()=>{if(!(!u.trim()||!n))try{v(!0);const o=(await d.sendMessage(n.id,{content:u.trim(),message_type:"text"})).data;o&&C(W=>[...W,o]),y("")}catch(s){console.error("Error sending message:",s),g("Erro ao enviar mensagem")}finally{v(!1)}},X=async s=>{n&&console.log(`Transferring conversation ${n.id} to ${s}`)},Y=z.filter(s=>{if(!m)return!0;const o=m.toLowerCase();return s.sender_name?.toLowerCase().includes(o)||s.last_message?.toLowerCase().includes(o)}),Z=s=>{if(!s)return"";const o=new Date(s),F=Math.floor((new Date().getTime()-o.getTime())/(1e3*60*60*24));return F===0?o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):F===1?"Ontem":F<7?o.toLocaleDateString("pt-BR",{weekday:"short"}):o.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})},ce=s=>{switch(s){case"bot":return e.jsx(T,{fontSize:"small",color:"primary"});case"human":return e.jsx(N,{fontSize:"small",color:"success"});default:return e.jsx(T,{fontSize:"small",color:"disabled"})}};return e.jsxs(a,{sx:{display:"flex",height:"calc(100vh - 100px)",gap:2,p:2},children:[e.jsxs(L,{sx:{width:360,display:"flex",flexDirection:"column"},children:[e.jsxs(a,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,mb:2,children:[e.jsx(R,{sx:{color:"#0084FF",fontSize:28}}),e.jsx(i,{variant:"h6",fontWeight:"bold",children:"Messenger"}),e.jsx(a,{flex:1}),e.jsx(H,{title:"Atualizar",children:e.jsx(B,{size:"small",onClick:G,children:e.jsx(De,{})})})]}),E.length>1&&e.jsxs(ue,{fullWidth:!0,size:"small",sx:{mb:2},children:[e.jsx(xe,{children:"Página"}),e.jsx(he,{value:p,label:"Página",onChange:s=>b(s.target.value),children:E.map(s=>e.jsx(me,{value:s.id,children:s.page_name},s.id))})]}),e.jsx(j,{fullWidth:!0,size:"small",placeholder:"Buscar conversas...",value:m,onChange:s=>$(s.target.value),InputProps:{startAdornment:e.jsx(oe,{position:"start",children:e.jsx(Me,{fontSize:"small"})})}})]}),e.jsx(fe,{sx:{flex:1,overflow:"auto",py:0},children:l?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(I,{})}):Y.length===0?e.jsxs(a,{textAlign:"center",py:4,px:2,children:[e.jsx(R,{sx:{fontSize:48,color:"text.disabled",mb:1}}),e.jsx(i,{color:"text.secondary",children:m?"Nenhuma conversa encontrada":"Nenhuma conversa ainda"})]}):Y.map(s=>e.jsxs(de.Fragment,{children:[e.jsxs(pe,{selected:n?.id===s.id,onClick:()=>q(s),sx:{py:1.5},children:[e.jsx(ge,{children:e.jsx(je,{badgeContent:s.unread_count,color:"error",overlap:"circular",children:e.jsx(ee,{children:s.sender_name?.[0]?.toUpperCase()||"U"})})}),e.jsx(ye,{primary:e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(i,{variant:"body2",fontWeight:s.unread_count>0?"bold":"normal",noWrap:!0,children:s.sender_name||"Usuário"}),e.jsxs(a,{display:"flex",alignItems:"center",gap:.5,children:[ce(s.handover_status),e.jsx(i,{variant:"caption",color:"text.secondary",children:Z(s.last_message_at)})]})]}),secondary:e.jsx(i,{variant:"caption",color:s.unread_count>0?"text.primary":"text.secondary",fontWeight:s.unread_count>0?500:400,noWrap:!0,children:s.last_message||"Nenhuma mensagem"})})]}),e.jsx(ve,{component:"li"})]},s.id))})]}),e.jsx(L,{sx:{flex:1,display:"flex",flexDirection:"column"},children:n?e.jsxs(e.Fragment,{children:[e.jsxs(a,{sx:{p:2,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",gap:2},children:[e.jsx(ee,{sx:{width:48,height:48},children:n.sender_name?.[0]?.toUpperCase()}),e.jsxs(a,{flex:1,children:[e.jsx(i,{variant:"subtitle1",fontWeight:"bold",children:n.sender_name}),e.jsx(i,{variant:"caption",color:"text.secondary",children:n.handover_status==="bot"?"Modo Bot":"Atendimento Humano"})]}),e.jsxs(a,{display:"flex",gap:1,children:[e.jsx(A,{icon:e.jsx(T,{}),label:"Bot",color:n.handover_status==="bot"?"primary":"default",size:"small",onClick:()=>X("bot"),sx:{cursor:"pointer"}}),e.jsx(A,{icon:e.jsx(N,{}),label:"Humano",color:n.handover_status==="human"?"success":"default",size:"small",onClick:()=>X("human"),sx:{cursor:"pointer"}})]})]}),e.jsxs(a,{sx:{flex:1,overflow:"auto",p:2,display:"flex",flexDirection:"column",gap:1,bgcolor:"grey.50"},children:[D?e.jsx(a,{display:"flex",justifyContent:"center",py:4,children:e.jsx(I,{})}):_.length===0?e.jsx(a,{textAlign:"center",py:4,children:e.jsx(i,{color:"text.secondary",children:"Nenhuma mensagem ainda. Envie a primeira!"})}):_.map(s=>e.jsx(a,{sx:{display:"flex",justifyContent:s.is_from_bot?"flex-end":"flex-start"},children:e.jsxs(be,{sx:{p:1.5,maxWidth:"70%",bgcolor:s.is_from_bot?"primary.main":"white",color:s.is_from_bot?"white":"text.primary",borderRadius:2,borderTopRightRadius:s.is_from_bot?0:2,borderTopLeftRadius:s.is_from_bot?2:0},children:[s.attachments&&s.attachments.length>0&&e.jsx(a,{mb:1,children:s.attachments.map((o,W)=>e.jsx(a,{children:o.type==="image"?e.jsx("img",{src:o.url,alt:"Attachment",style:{maxWidth:"100%",borderRadius:8}}):e.jsx(A,{label:o.name||o.type,size:"small"})},W))}),s.content&&e.jsx(i,{variant:"body2",children:s.content}),e.jsx(i,{variant:"caption",sx:{opacity:.7,fontSize:"0.65rem",display:"block",textAlign:"right",mt:.5},children:Z(s.created_at)})]})},s.id)),e.jsx("div",{ref:w})]}),e.jsxs(a,{sx:{p:2,borderTop:1,borderColor:"divider",display:"flex",gap:1},children:[e.jsx(j,{fullWidth:!0,placeholder:"Digite uma mensagem...",value:u,onChange:s=>y(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),J())},multiline:!0,maxRows:4,disabled:h}),e.jsx(B,{color:"primary",onClick:J,disabled:!u.trim()||h,sx:{bgcolor:"primary.main",color:"white","&:hover":{bgcolor:"primary.dark"},"&:disabled":{bgcolor:"grey.300"}},children:h?e.jsx(I,{size:24,color:"inherit"}):e.jsx(We,{})})]})]}):e.jsxs(a,{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flex:1,color:"text.secondary",children:[e.jsx(R,{sx:{fontSize:80,color:"#0084FF",opacity:.5,mb:2}}),e.jsx(i,{variant:"h6",children:"Selecione uma conversa"}),e.jsx(i,{variant:"body2",children:"Escolha uma conversa da lista para ver as mensagens"})]})}),M&&e.jsx(ie,{severity:"error",sx:{position:"fixed",bottom:16,right:16},onClose:()=>g(null),children:M})]})}function Ye(){const[E,P]=r.useState([]),[p,b]=r.useState(!0),[z,x]=r.useState(null),[n,q]=r.useState(""),[_,C]=r.useState(!1),[u,y]=r.useState(null),[l,c]=r.useState({name:"",page_id:"",page_name:"",page_access_token:""}),[D,S]=r.useState(!1);r.useEffect(()=>{h()},[]);const h=async()=>{try{b(!0);const t=await d.getAccounts();P(t.data||[]),x(null)}catch(t){console.error("Error loading accounts:",t),x("Erro ao carregar contas do Messenger")}finally{b(!1)}},v=t=>{t?(y(t),c({name:t.name||t.page_name,page_id:t.page_id,page_name:t.page_name,page_access_token:""})):(y(null),c({name:"",page_id:"",page_name:"",page_access_token:""})),C(!0)},m=()=>{C(!1),y(null),c({name:"",page_id:"",page_name:"",page_access_token:""})},$=async()=>{try{S(!0),u?await d.updateAccount(u.id,l):await d.createAccount(l),m(),h()}catch(t){console.error("Error saving account:",t),x("Erro ao salvar conta")}finally{S(!1)}},M=async t=>{if(confirm("Tem certeza que deseja excluir esta conta?"))try{await d.deleteAccount(t),h()}catch(f){console.error("Error deleting account:",f),x("Erro ao excluir conta")}},g=async t=>{try{await d.verifyWebhook(t),h()}catch(f){console.error("Error verifying webhook:",f),x("Erro ao verificar webhook")}},w=E.filter(t=>{if(!n)return!0;const f=n.toLowerCase();return t.page_name?.toLowerCase().includes(f)||t.page_id?.toLowerCase().includes(f)});return e.jsxs(a,{p:3,children:[e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(i,{variant:"h4",fontWeight:"bold",children:"Contas do Messenger"}),e.jsxs(a,{display:"flex",gap:2,children:[e.jsx(j,{size:"small",placeholder:"Buscar contas...",value:n,onChange:t=>q(t.target.value),InputProps:{startAdornment:e.jsx(oe,{position:"start",children:e.jsx(_e,{fontSize:"small"})})}}),e.jsx(k,{variant:"contained",startIcon:e.jsx(se,{}),onClick:()=>v(),children:"Adicionar Conta"})]})]}),z&&e.jsx(ie,{severity:"error",sx:{mb:3},onClose:()=>x(null),children:z}),p?e.jsx(a,{display:"flex",justifyContent:"center",py:8,children:e.jsx(I,{})}):w.length===0?e.jsx(L,{children:e.jsxs(te,{sx:{textAlign:"center",py:8},children:[e.jsx(Ce,{sx:{fontSize:64,color:"text.disabled",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"Nenhuma conta configurada"}),e.jsx(i,{variant:"body2",color:"text.secondary",mb:3,children:"Adicione uma página do Facebook para começar a receber mensagens"}),e.jsx(k,{variant:"contained",startIcon:e.jsx(se,{}),onClick:()=>v(),children:"Adicionar Conta"})]})}):e.jsx(ae,{container:!0,spacing:3,children:w.map(t=>e.jsx(ae,{item:!0,xs:12,md:6,lg:4,children:e.jsx(L,{children:e.jsxs(te,{children:[e.jsxs(a,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2,children:[e.jsxs(a,{children:[e.jsx(i,{variant:"h6",fontWeight:"bold",children:t.page_name}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:["ID: ",t.page_id]})]}),e.jsxs(a,{display:"flex",gap:1,children:[e.jsx(H,{title:"Editar",children:e.jsx(B,{size:"small",onClick:()=>v(t),children:e.jsx(Se,{fontSize:"small"})})}),e.jsx(H,{title:"Excluir",children:e.jsx(B,{size:"small",color:"error",onClick:()=>M(t.id),children:e.jsx(we,{fontSize:"small"})})})]})]}),e.jsxs(a,{display:"flex",gap:1,mb:2,children:[e.jsx(A,{size:"small",icon:t.is_active?e.jsx(re,{}):e.jsx(ne,{}),label:t.is_active?"Ativo":"Inativo",color:t.is_active?"success":"default"}),e.jsx(A,{size:"small",icon:t.webhook_verified?e.jsx(re,{}):e.jsx(ne,{}),label:t.webhook_verified?"Webhook OK":"Webhook Pendente",color:t.webhook_verified?"success":"warning"})]}),!t.webhook_verified&&e.jsx(k,{fullWidth:!0,variant:"outlined",size:"small",startIcon:e.jsx(ke,{}),onClick:()=>g(t.id),children:"Verificar Webhook"})]})})},t.id))}),e.jsxs(Ie,{open:_,onClose:m,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ae,{children:u?"Editar Conta":"Adicionar Conta do Messenger"}),e.jsx(Ee,{children:e.jsxs(a,{display:"flex",flexDirection:"column",gap:2,mt:1,children:[e.jsx(j,{label:"Nome da Conta",value:l.name,onChange:t=>c({...l,name:t.target.value}),fullWidth:!0,required:!0,helperText:"Nome para identificar esta conta no painel"}),e.jsx(j,{label:"Page ID",value:l.page_id,onChange:t=>c({...l,page_id:t.target.value}),fullWidth:!0,required:!0,disabled:!!u}),e.jsx(j,{label:"Nome da Página",value:l.page_name,onChange:t=>c({...l,page_name:t.target.value}),fullWidth:!0,required:!0}),e.jsx(j,{label:"Page Access Token",value:l.page_access_token,onChange:t=>c({...l,page_access_token:t.target.value}),fullWidth:!0,required:!0,type:"password",helperText:"Token de acesso da página do Facebook"})]})}),e.jsxs(ze,{children:[e.jsx(k,{onClick:m,children:"Cancelar"}),e.jsx(k,{variant:"contained",onClick:$,disabled:D||!l.name||!l.page_id||!l.page_name||!l.page_access_token,children:D?e.jsx(I,{size:24}):"Salvar"})]})]})]})}export{Ye as MessengerAccounts,Xe as MessengerInbox};
