import{j as e}from"./vendor-charts-o9Lo7m6Z.js";import{r}from"./vendor-react-C2HNIXra.js";import{E as ee,D as J,ak as xe,bn as ge,p as V,b4 as K,aM as he,br as O,bc as H,ay as pe,ar as te,e as fe,bs as be,M as L,z as we,bt as ye,bu as ve,aj as je,bv as Ne,u as ke,am as P,R as A,Z as U,U as B,i as X,w as Ce,aa as _e,aU as Se}from"./feature-automation-CLWK1V5x.js";import{i as Me,g as q}from"./vendor-utils-DaXQUBrP.js";const We=({name:t,phoneNumber:o,profilePictureUrl:i})=>{if(i)return e.jsx("img",{src:i,alt:t||"Contato",className:"w-12 h-12 rounded-full object-cover",onError:d=>{d.target.style.display="none"}});const f=t?t.split(" ").map(d=>d[0]).join("").toUpperCase().slice(0,2):o.slice(-2),c=["bg-blue-500","bg-green-500","bg-yellow-500","bg-purple-500","bg-pink-500","bg-indigo-500","bg-red-500","bg-teal-500"],s=o.split("").reduce((d,m)=>d+m.charCodeAt(0),0)%c.length,x=c[s];return e.jsx("div",{className:`w-12 h-12 rounded-full ${x} flex items-center justify-center text-white font-semibold text-sm`,children:f})},Re=({contact:t,isSelected:o,onClick:i})=>{const f=t.contactName||t.phoneNumber,c=t.lastMessageAt?Me(new Date(t.lastMessageAt),{addSuffix:!0,locale:V}):"";return e.jsxs("button",{onClick:i,className:`
        w-full flex items-center gap-3 p-3 text-left transition-colors
        ${o?"bg-primary-50 dark:bg-primary-900/20 border-l-4 border-primary-500":"hover:bg-gray-50 dark:hover:bg-zinc-700/50 border-l-4 border-transparent"}
      `,children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx(We,{name:t.contactName,phoneNumber:t.phoneNumber,profilePictureUrl:t.profilePictureUrl}),t.unreadCount&&t.unreadCount>0&&e.jsx("span",{className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-medium",children:t.unreadCount>9?"9+":t.unreadCount})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:`font-medium truncate ${t.unreadCount?"text-gray-900 dark:text-white":"text-gray-700 dark:text-zinc-300"}`,children:f}),e.jsx("span",{className:"text-xs text-gray-400 flex-shrink-0",children:c})]}),e.jsx("div",{className:"flex items-center gap-2 mt-0.5",children:t.isTyping?e.jsx("span",{className:"text-sm text-primary-500 italic",children:"Digitando..."}):e.jsx("span",{className:`text-sm truncate ${t.unreadCount?"text-gray-700 dark:text-gray-200 font-medium":"text-gray-500 dark:text-zinc-400"}`,children:t.lastMessagePreview||"Nenhuma mensagem"})}),t.mode&&e.jsx("span",{className:`
            inline-flex items-center mt-1 px-1.5 py-0.5 text-[10px] rounded-full
            ${t.mode==="human"?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":""}
            ${t.mode==="auto"?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":""}
            ${t.mode==="hybrid"?"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300":""}
          `,children:t.mode==="human"?"ðŸ‘¤ Humano":t.mode==="auto"?"ðŸ¤– Auto":"ðŸ”„ HÃ­brido"})]})]})},$e=({contacts:t,selectedContactId:o,onSelectContact:i,isLoading:f=!1,emptyMessage:c="Nenhuma conversa encontrada"})=>{const s=t||[],[x,d]=r.useState(""),[m,w]=r.useState(null),[N,j]=r.useState(!1),k=r.useMemo(()=>{let g=s;if(x.trim()){const h=x.toLowerCase();g=g.filter(R=>R.contactName?.toLowerCase().includes(h)||R.phoneNumber.includes(h)||R.lastMessagePreview?.toLowerCase().includes(h))}return m&&(g=g.filter(h=>h.mode===m)),g},[s,x,m]),M=r.useMemo(()=>[...k].sort((g,h)=>(g.unreadCount||0)>0&&(h.unreadCount||0)===0?-1:(g.unreadCount||0)===0&&(h.unreadCount||0)>0||!g.lastMessageAt?1:h.lastMessageAt?new Date(h.lastMessageAt).getTime()-new Date(g.lastMessageAt).getTime():-1),[k]),v=r.useMemo(()=>{const g={human:0,auto:0,hybrid:0};return s.forEach(h=>{h.mode&&g[h.mode]!==void 0&&g[h.mode]++}),g},[s]),_=r.useMemo(()=>s.reduce((g,h)=>g+(h.unreadCount||0),0),[s]);return e.jsxs("div",{className:"flex flex-col h-full bg-white dark:bg-zinc-900 border-r border-gray-200 dark:border-zinc-800",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-zinc-800 bg-gray-50 dark:bg-black",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:"Conversas"}),_>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-red-500 text-white text-xs rounded-full font-medium",children:[_," nÃ£o lida",_!==1?"s":""]})]})}),e.jsxs("div",{className:"p-3 border-b border-gray-200 dark:border-zinc-800 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar...",value:x,onChange:g=>d(g.target.value),className:"w-full pl-9 pr-4 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 dark:text-white"}),x&&e.jsx("button",{onClick:()=>d(""),className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600",children:e.jsx(J,{className:"w-4 h-4"})})]}),e.jsx("button",{onClick:()=>j(!N),className:`p-2 rounded-lg transition-colors ${N||m?"bg-primary-100 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400":"bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-zinc-400 hover:bg-gray-200 dark:hover:bg-gray-600"}`,title:"Filtros",children:e.jsx(xe,{className:"w-5 h-5"})})]}),N&&e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsxs("button",{onClick:()=>w(null),className:`px-2 py-1 text-xs rounded-full transition-colors ${m?"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-zinc-400 hover:bg-gray-200":"bg-primary-500 text-white"}`,children:["Todas (",s.length,")"]}),e.jsxs("button",{onClick:()=>w("human"),className:`px-2 py-1 text-xs rounded-full transition-colors ${m==="human"?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-zinc-400 hover:bg-gray-200"}`,children:["ðŸ‘¤ Humano (",v.human,")"]}),e.jsxs("button",{onClick:()=>w("auto"),className:`px-2 py-1 text-xs rounded-full transition-colors ${m==="auto"?"bg-green-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-zinc-400 hover:bg-gray-200"}`,children:["ðŸ¤– Auto (",v.auto,")"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:f?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mb-2"}),e.jsx("span",{className:"text-sm",children:"Carregando..."})]}):M.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 p-4",children:[e.jsx(ge,{className:"w-12 h-12 mb-2"}),e.jsx("span",{className:"text-sm text-center",children:x||m?"Nenhuma conversa encontrada com os filtros aplicados":c}),(x||m)&&e.jsx("button",{onClick:()=>{d(""),w(null)},className:"mt-2 text-primary-500 text-sm hover:underline",children:"Limpar filtros"})]}):e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:M.map(g=>e.jsx(Re,{contact:g,isSelected:g.id===o,onClick:()=>i(g)},g.id))})}),e.jsx("div",{className:"p-2 border-t border-gray-200 dark:border-zinc-800 text-center bg-gray-50 dark:bg-black",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[M.length," de ",s.length," conversa",s.length!==1?"s":""]})})]})};function Ae({title:t,titleId:o,...i},f){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:f,"aria-labelledby":o},i),t?r.createElement("title",{id:o},t):null,r.createElement("path",{fillRule:"evenodd",d:"M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z",clipRule:"evenodd"}))}const Y=r.forwardRef(Ae),Ee=({status:t})=>{switch(t){case"pending":return e.jsx(we,{className:"w-3.5 h-3.5 text-gray-400",title:"Pendente"});case"sent":return e.jsx(L,{className:"w-3.5 h-3.5 text-gray-400",title:"Enviado"});case"delivered":return e.jsxs("div",{className:"flex -space-x-1",title:"Entregue",children:[e.jsx(L,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx(L,{className:"w-3.5 h-3.5 text-gray-400"})]});case"read":return e.jsxs("div",{className:"flex -space-x-1",title:"Lido",children:[e.jsx(Y,{className:"w-3.5 h-3.5 text-blue-500"}),e.jsx(Y,{className:"w-3.5 h-3.5 text-blue-500"})]});case"failed":return e.jsx(be,{className:"w-3.5 h-3.5 text-red-500",title:"Falhou"});default:return null}},ze=({type:t,url:o,fileName:i,content:f,onClick:c})=>{if((t==="image"||t==="sticker")&&o)return e.jsxs("div",{className:"relative group cursor-pointer mb-2 overflow-hidden rounded-lg",onClick:c,children:[e.jsx("img",{src:o,alt:"Imagem",className:"max-w-[280px] max-h-[200px] object-cover rounded-lg hover:opacity-90 transition-opacity"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center",children:e.jsx(K,{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]});if(t==="video"&&o)return e.jsxs("div",{className:"relative group cursor-pointer mb-2 overflow-hidden rounded-lg",onClick:c,children:[e.jsx("video",{src:o,className:"max-w-[280px] max-h-[200px] object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/40 transition-colors",children:e.jsx("div",{className:"w-12 h-12 bg-white/80 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"w-6 h-6 text-gray-800 ml-1"})})})]});if(t==="audio"&&o)return e.jsx("div",{className:"w-[260px] mb-2",children:e.jsx("audio",{src:o,controls:!0,className:"w-full h-10"})});if(t==="document")return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-100/50 dark:bg-black/20 rounded-lg mb-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-black/30 transition-colors max-w-[280px]",onClick:c,children:[e.jsx("div",{className:"w-10 h-10 bg-violet-100 dark:bg-violet-900/30 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(O,{className:"w-5 h-5 text-violet-600 dark:text-violet-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200 truncate",children:i||"Documento"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Clique para baixar"})]}),e.jsx(H,{className:"w-4 h-4 text-gray-400"})]});if(t==="location"){const s=f?.location,x=s?.latitude&&s?.longitude?`https://www.google.com/maps?q=${s.latitude},${s.longitude}`:"#";return e.jsxs("a",{href:x,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg mb-2 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors max-w-[280px]",children:[e.jsx(pe,{className:"w-8 h-8 text-red-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:s?.name||"LocalizaÃ§Ã£o"}),e.jsx("p",{className:"text-xs text-red-600 dark:text-red-400",children:"Abrir no Maps"})]})]})}if(t==="contacts"){const x=f?.contacts?.[0];return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg mb-2 max-w-[280px]",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center",children:e.jsx(te,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:x?.name?.formatted_name||"Contato"}),x?.phones?.[0]?.phone&&e.jsx("p",{className:"text-xs text-gray-500",children:x.phones[0].phone})]})]})}return t==="order"?e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg mb-2 max-w-[280px]",children:[e.jsx(fe,{className:"w-8 h-8 text-green-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Pedido"})]}):null},De=({direction:t,messageType:o,status:i,textBody:f,content:c,mediaUrl:s,mediaType:x,fileName:d,createdAt:m,errorMessage:w,onMediaClick:N})=>{const j=t==="outbound",k=["image","video","audio","document","sticker","location","contacts","order"].includes(o);return e.jsx("div",{className:`flex ${j?"justify-end":"justify-start"} mb-3`,children:e.jsxs("div",{className:`
          max-w-[80%] sm:max-w-[70%] rounded-2xl shadow-sm
          ${j?"bg-[#dcf8c6] dark:bg-emerald-800/80 text-gray-800 dark:text-white rounded-br-sm":"bg-white dark:bg-zinc-800 text-gray-800 dark:text-white rounded-bl-sm"}
        `,children:[k&&e.jsx("div",{className:"p-1",children:e.jsx(ze,{type:o,url:s,fileName:d,content:c,onClick:()=>s&&N?.(s,x||o,d)})}),f&&e.jsx("div",{className:"px-3 pb-1",children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:f})}),i==="failed"&&w&&e.jsx("p",{className:"px-3 text-xs text-red-500 mt-1",children:w}),e.jsxs("div",{className:`flex items-center justify-end gap-1 px-3 pb-1.5 pt-1 ${j?"text-gray-500 dark:text-gray-300":"text-gray-400"}`,children:[e.jsx("span",{className:"text-[11px]",children:q(new Date(m),"HH:mm",{locale:V})}),j&&e.jsx(Ee,{status:i})]})]})})},Te=({onSend:t,onTyping:o,onFileSelect:i,placeholder:f="Digite uma mensagem...",disabled:c=!1,isLoading:s=!1,showAttachment:x=!0,maxLength:d=4096,selectedFile:m,onClearFile:w})=>{const[N,j]=r.useState(""),k=r.useRef(null),M=r.useRef(null),v=r.useRef(void 0),_=r.useRef(!1),g=r.useCallback(()=>{const y=k.current;y&&(y.style.height="auto",y.style.height=`${Math.min(y.scrollHeight,120)}px`)},[]);r.useEffect(()=>{g()},[N,g]);const h=r.useCallback(()=>{o&&(v.current&&window.clearTimeout(v.current),_.current||(_.current=!0,o(!0)),v.current=window.setTimeout(()=>{_.current=!1,o(!1)},2e3))},[o]);r.useEffect(()=>()=>{v.current&&window.clearTimeout(v.current),_.current&&o&&o(!1)},[o]);const R=y=>{const $=y.target.value;$.length<=d&&(j($),h())},z=()=>{const y=N.trim();(y||m)&&!c&&!s&&(t(y),j(""),v.current&&window.clearTimeout(v.current),_.current&&o&&(_.current=!1,o(!1)),k.current&&(k.current.style.height="auto"))},D=y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),z())},p=y=>{const $=y.target.files?.[0];$&&i&&i($),M.current&&(M.current.value="")},l=(N.trim().length>0||m)&&!c&&!s,W=()=>{if(!m)return null;const y=m.type.startsWith("image/");return e.jsxs("div",{className:"flex items-center gap-3 p-3 mx-4 mb-2 bg-gray-50 dark:bg-zinc-800 rounded-lg border border-gray-200 dark:border-zinc-700",children:[y?e.jsx(K,{className:"w-8 h-8 text-violet-500"}):e.jsx(O,{className:"w-8 h-8 text-blue-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-200 truncate",children:m.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(m.size/1024/1024).toFixed(2)," MB"]})]}),e.jsx("button",{onClick:w,className:"p-1 text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(J,{className:"w-5 h-5"})})]})};return e.jsxs("div",{className:"bg-white dark:bg-zinc-900",children:[W(),e.jsxs("div",{className:"flex items-end gap-2 p-3",children:[x&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>M.current?.click(),disabled:c,className:"p-2.5 text-gray-500 hover:text-violet-600 hover:bg-violet-50 dark:hover:bg-violet-900/20 rounded-full disabled:opacity-50 transition-colors",title:"Anexar arquivo",children:e.jsx(ye,{className:"w-5 h-5"})}),e.jsx("input",{ref:M,type:"file",accept:"image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt",onChange:p,className:"hidden"})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("textarea",{ref:k,value:N,onChange:R,onKeyDown:D,placeholder:f,disabled:c,rows:1,className:`
              w-full resize-none rounded-full border border-gray-300 dark:border-zinc-600
              bg-white dark:bg-zinc-800 px-4 py-3 pr-12
              text-sm text-gray-900 dark:text-white
              placeholder-gray-400 dark:placeholder-zinc-500
              focus:ring-2 focus:ring-violet-500 focus:border-transparent
              disabled:opacity-50 disabled:cursor-not-allowed
              transition-all min-h-[44px] max-h-[120px]
            `}),N.length>d*.8&&e.jsxs("span",{className:`absolute right-4 bottom-3 text-xs ${N.length>=d?"text-red-500":"text-gray-400"}`,children:[N.length,"/",d]})]}),e.jsx("button",{type:"button",disabled:c,className:"p-2.5 text-gray-500 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-full disabled:opacity-50 transition-colors hidden sm:block",title:"Emoji",children:e.jsx(ve,{className:"w-5 h-5"})}),e.jsx("button",{type:"button",onClick:z,disabled:!l,className:`
            p-3 rounded-full transition-all
            ${l?"bg-violet-600 text-white hover:bg-violet-700 shadow-md hover:shadow-lg transform hover:scale-105":"bg-gray-200 dark:bg-zinc-700 text-gray-400 cursor-not-allowed"}
          `,title:"Enviar",children:s?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(je,{className:"w-5 h-5"})})]}),e.jsx("p",{className:"text-[10px] text-gray-400 pb-2 px-4 text-center hidden sm:block",children:"Enter para enviar â€¢ Shift+Enter para nova linha"})]})},Fe=({url:t,type:o,fileName:i,onClose:f})=>{const c=o.startsWith("image/")||["image","sticker"].includes(o),s=o.startsWith("video/")||o==="video",x=o.startsWith("audio/")||o==="audio",d=!c&&!s&&!x,m=()=>{const w=document.createElement("a");w.href=t,w.download=i||"download",document.body.appendChild(w),w.click(),document.body.removeChild(w)};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm",onClick:f,children:[e.jsxs("div",{className:"absolute top-0 left-0 right-0 flex items-center justify-between p-4 bg-gradient-to-b from-black/80 to-transparent",children:[e.jsxs("div",{className:"flex items-center gap-3 text-white",children:[c&&e.jsx(K,{className:"w-6 h-6"}),s&&e.jsx(Ne,{className:"w-6 h-6"}),d&&e.jsx(O,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-md",children:i||"Visualizador de MÃ­dia"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:w=>{w.stopPropagation(),m()},className:"p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-colors",title:"Baixar",children:e.jsx(H,{className:"w-6 h-6"})}),e.jsx("button",{onClick:f,className:"p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-colors",title:"Fechar",children:e.jsx(J,{className:"w-6 h-6"})})]})]}),e.jsxs("div",{className:"max-w-[90vw] max-h-[90vh]",onClick:w=>w.stopPropagation(),children:[c&&e.jsx("img",{src:t,alt:i||"Imagem",className:"max-w-full max-h-[85vh] object-contain rounded-lg"}),s&&e.jsx("video",{src:t,controls:!0,className:"max-w-full max-h-[85vh] rounded-lg",autoPlay:!0}),x&&e.jsx("div",{className:"bg-white dark:bg-zinc-800 rounded-lg p-8",children:e.jsx("audio",{src:t,controls:!0,className:"w-96"})}),d&&e.jsxs("div",{className:"bg-white dark:bg-zinc-800 rounded-lg p-8 text-center",children:[e.jsx(O,{className:"w-24 h-24 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:i||"Documento"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Este arquivo nÃ£o pode ser visualizado diretamente"}),e.jsxs("button",{onClick:m,className:"inline-flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors",children:[e.jsx(H,{className:"w-5 h-5"}),"Baixar Arquivo"]})]})]})]})};function Pe(t={}){const{token:o}=ke(),i=r.useRef(null),f=r.useRef(void 0),c=r.useRef(void 0),s=r.useRef(0),x=r.useRef(!1),d=r.useRef(t);d.current=t;const[m,w]=r.useState(!1),[N,j]=r.useState(null),{accountId:k,dashboardMode:M=!1,enabled:v=!0}=t,_=r.useCallback(()=>{if(!o)return null;let p;p||(p=window.location.host);const l=p.includes("railway")||p.includes("vercel")||location.protocol==="https:"?"wss":"ws";return M?`${l}://${p}/ws/whatsapp/dashboard/?token=${o}`:k?`${l}://${p}/ws/whatsapp/${k}/?token=${o}`:null},[o,k,M]),g=r.useCallback(p=>{try{const l=JSON.parse(p.data);if(l.type==="pong")return;if(l.type==="connection_established"){console.log("[WhatsApp WS] Connection confirmed:",l);return}if(l.type==="subscribed"||l.type==="unsubscribed"){console.log(`[WhatsApp WS] ${l.type}:`,l);return}if(l.type==="read_receipt_sent"){console.log("[WhatsApp WS] Read receipt sent:",l);return}switch(console.log("[WhatsApp WS] Event received:",l.type,JSON.stringify(l,null,2)),l.type){case"message_received":console.log("[WhatsApp WS] Calling onMessageReceived callback"),d.current.onMessageReceived?.(l);break;case"message_sent":console.log("[WhatsApp WS] Calling onMessageSent callback"),d.current.onMessageSent?.(l);break;case"status_updated":console.log("[WhatsApp WS] Calling onStatusUpdated callback"),d.current.onStatusUpdated?.(l);break;case"typing":d.current.onTyping?.(l);break;case"conversation_updated":console.log("[WhatsApp WS] Calling onConversationUpdated callback"),d.current.onConversationUpdated?.(l);break;case"error":console.error("[WhatsApp WS] Error event:",l),d.current.onError?.(l);break;default:console.log("[WhatsApp WS] Unknown event type:",l.type,l)}}catch(l){console.error("[WhatsApp WS] Parse error:",l,"Raw data:",p.data)}},[]),h=r.useCallback(()=>{const p=_();if(!p||!v){console.log("[WhatsApp WS] Skipping connection (no URL or disabled)");return}if(x.current){console.log("[WhatsApp WS] Already connecting");return}if(i.current?.readyState===WebSocket.OPEN){console.log("[WhatsApp WS] Already connected");return}i.current&&(i.current.onclose=null,i.current.close(),i.current=null),x.current=!0,console.log("[WhatsApp WS] Connecting to:",p.replace(/token=.*/,"token=***"));try{const l=new WebSocket(p);i.current=l,l.onopen=()=>{console.log("[WhatsApp WS] Connected âœ“"),x.current=!1,w(!0),j(null),s.current=0,d.current.onConnectionChange?.(!0),c.current&&window.clearInterval(c.current),c.current=window.setInterval(()=>{l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"ping"}))},25e3)},l.onmessage=g,l.onclose=W=>{if(console.log("[WhatsApp WS] Closed:",W.code,W.reason),x.current=!1,w(!1),d.current.onConnectionChange?.(!1),c.current&&(window.clearInterval(c.current),c.current=void 0),W.code!==1e3&&s.current<10&&v){const y=Math.min(1e3*Math.pow(1.5,s.current),3e4);console.log(`[WhatsApp WS] Reconnecting in ${Math.round(y)}ms (attempt ${s.current+1}/10)`),j("Reconectando..."),f.current=window.setTimeout(()=>{s.current++,h()},y)}else s.current>=10&&j("ConexÃ£o perdida. Atualize a pÃ¡gina.")},l.onerror=W=>{console.error("[WhatsApp WS] Error:",W),x.current=!1}}catch(l){console.error("[WhatsApp WS] Connection error:",l),x.current=!1}},[_,v,g]),R=r.useCallback(p=>{i.current?.readyState===WebSocket.OPEN&&i.current.send(JSON.stringify({type:"subscribe_conversation",conversation_id:p}))},[]),z=r.useCallback(p=>{i.current?.readyState===WebSocket.OPEN&&i.current.send(JSON.stringify({type:"unsubscribe_conversation",conversation_id:p}))},[]),D=r.useCallback((p,l)=>{i.current?.readyState===WebSocket.OPEN&&i.current.send(JSON.stringify({type:"typing",conversation_id:p,is_typing:l}))},[]);return r.useEffect(()=>{v&&(k||M)&&h();const p=()=>{document.visibilityState==="visible"&&v&&(!i.current||i.current.readyState!==WebSocket.OPEN)&&(console.log("[WhatsApp WS] Tab visible, reconnecting..."),s.current=0,h())};return document.addEventListener("visibilitychange",p),()=>{document.removeEventListener("visibilitychange",p),f.current&&window.clearTimeout(f.current),c.current&&window.clearInterval(c.current),i.current&&(i.current.onclose=null,i.current.close(1e3),i.current=null)}},[h,v,k,M]),{isConnected:m,connectionError:N,subscribeToConversation:R,unsubscribeFromConversation:z,sendTypingIndicator:D}}const Ue=t=>({id:t.id,direction:t.direction,messageType:t.message_type,status:t.status,textBody:t.text_body,content:t.content,mediaUrl:t.media_url,mediaType:t.media_type,fileName:t.file_name,createdAt:t.created_at,sentAt:t.sent_at??void 0,deliveredAt:t.delivered_at??void 0,readAt:t.read_at??void 0,errorMessage:t.error_message}),Oe=t=>({id:t.id,phoneNumber:t.phone_number,contactName:t.contact_name||"",lastMessagePreview:t.last_message_preview||"",lastMessageAt:t.last_message_at??void 0,unreadCount:t.unread_count||0,status:t.status,mode:t.mode}),Je=({accountId:t,accountName:o,onConversationSelect:i})=>{const[f,c]=r.useState([]),[s,x]=r.useState(null),[d,m]=r.useState([]),[w,N]=r.useState(!0),[j,k]=r.useState(!1),[M,v]=r.useState(!1),[_,g]=r.useState(new Set),[h,R]=r.useState(null),[z,D]=r.useState(!1),[p,l]=r.useState(!0),W=r.useRef(null),y=r.useRef(null),{isConnected:$,connectionError:Q,subscribeToConversation:se,unsubscribeFromConversation:Z,sendTypingIndicator:ae}=Pe({accountId:t,enabled:!!t,onMessageReceived:re,onStatusUpdated:ne,onTyping:oe,onConversationUpdated:ie,onError:a=>{A.error(`Erro: ${a.error_message}`)}}),I=r.useCallback(async()=>{if(t){N(!0);try{console.log("[ChatWindow] Loading conversations for accountId:",t);const a=await P.getConversations({account:t});console.log("[ChatWindow] Conversations response:",a),c(a.results||[])}catch(a){console.error("[ChatWindow] Error loading conversations:",a),A.error(U(a))}finally{N(!1)}}},[t]),G=r.useCallback(async()=>{if(!(!s||!t)){k(!0);try{console.log("[ChatWindow] Loading messages for:",s.phone_number);const a=await B.getConversationHistory(t,s.phone_number,100);if(console.log("[ChatWindow] Messages loaded:",a.length),Array.isArray(a)){const n=[...a].sort((u,b)=>new Date(u.created_at).getTime()-new Date(b.created_at).getTime());m(n)}else console.warn("[ChatWindow] History nÃ£o Ã© um array:",a),m([]);if(s.unread_count&&s.unread_count>0)try{const n=await P.markAsRead(s.id);x(n),c(u=>u.map(b=>b.id===n.id?n:b))}catch(n){console.error("[ChatWindow] Error marking as read:",n)}}catch(a){console.error("[ChatWindow] Error loading messages:",a),A.error(U(a)),m([])}finally{k(!1)}}},[t,s]);function re(a){const n=a.message,u=a.conversation_id;if(console.log("[ChatWindow] Message received:",{messageConversationId:u,selectedConversationId:s?.id,match:u===s?.id,direction:n.direction}),s&&u===s.id&&(m(b=>b.some(S=>S.id===n.id||S.whatsapp_message_id&&S.whatsapp_message_id===n.whatsapp_message_id)?(console.log("[ChatWindow] Duplicate message ignored:",n.id),b):(console.log("[ChatWindow] Adding message to chat:",n.id),[...b,n].sort((S,F)=>new Date(S.created_at).getTime()-new Date(F.created_at).getTime()))),n.direction==="inbound"&&P.markAsRead(s.id).catch(b=>{console.error("[ChatWindow] Error marking as read:",b)})),c(b=>[...b.map(C=>{if(C.id===a.conversation_id){const S=s?.id===C.id;return{...C,last_message_at:n.created_at,last_message_preview:n.text_body?.substring(0,50)||"MÃ­dia",unread_count:S&&n.direction==="inbound"?0:n.direction==="inbound"?(C.unread_count||0)+1:C.unread_count}}return C})].sort((C,S)=>{const F=C.last_message_at?new Date(C.last_message_at).getTime():0;return(S.last_message_at?new Date(S.last_message_at).getTime():0)-F})),(!s||a.conversation_id!==s.id)&&n.direction==="inbound"){const b=a.contact?.name||n.from_number;A(`Nova mensagem de ${b}`,{icon:"ðŸ’¬"})}}function ne(a){m(n=>n.map(u=>{if(u.id===a.message_id||a.whatsapp_message_id&&u.whatsapp_message_id===a.whatsapp_message_id){const E={status:a.status};return a.status==="delivered"&&a.timestamp?E.delivered_at=a.timestamp:a.status==="read"&&a.timestamp&&(E.read_at=a.timestamp),{...u,...E}}return u}))}function oe(a){g(n=>{const u=new Set(n);return a.is_typing?u.add(a.conversation_id):u.delete(a.conversation_id),u})}function ie(a){I()}const le=async a=>{if(!(!s||!t)){v(!0);try{const n=await B.sendTextMessage({account_id:t,to:s.phone_number,text:a});m(u=>u.some(C=>C.id===n.id)?u:[...u,n].sort((C,S)=>new Date(C.created_at).getTime()-new Date(S.created_at).getTime()))}catch(n){A.error(U(n))}finally{v(!1)}}},ce=async a=>{const n=a.target.files?.[0];if(!(!n||!s||!t)){if(n.size>16*1024*1024){A.error("Arquivo muito grande. MÃ¡ximo 16MB.");return}D(!0);try{const u=await B.sendMediaMessage({account_id:t,to:s.phone_number,file:n,caption:""});m(b=>b.some(S=>S.id===u.id)?b:[...b,u].sort((S,F)=>new Date(S.created_at).getTime()-new Date(F.created_at).getTime())),A.success("Arquivo enviado!")}catch(u){A.error(U(u))}finally{D(!1),W.current&&(W.current.value="")}}},de=async()=>{if(s)try{const a=s.mode==="human"?"auto":"human",n=a==="human"?await P.switchToHuman(s.id):await P.switchToAuto(s.id);x(n),c(u=>u.map(b=>b.id===n.id?n:b)),A.success(`Modo alterado para ${a==="human"?"humano":"automÃ¡tico"}`)}catch(a){A.error(U(a))}};r.useEffect(()=>{y.current?.scrollIntoView({behavior:"smooth"})},[d]),r.useEffect(()=>{!j&&d.length>0&&y.current?.scrollIntoView({behavior:"auto"})},[j,d.length]),r.useEffect(()=>{I()},[I]);const T=r.useRef(null);r.useEffect(()=>(T.current&&T.current!==s?.id&&Z(T.current),m([]),s?(T.current=s.id,se(s.id),G(),i?.(s)):(T.current=null,i?.(null)),()=>{s&&Z(s.id)}),[s?.id]);const ue=d.reduce((a,n)=>{const u=q(new Date(n.created_at),"yyyy-MM-dd");return a[u]||(a[u]=[]),a[u].push(n),a},{}),me=f.map(a=>({...Oe(a),isTyping:_.has(a.id)}));return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)] bg-gray-100 dark:bg-zinc-950 rounded-xl overflow-hidden shadow-2xl",children:[e.jsx("div",{className:`${p?"w-80":"w-0"} transition-all duration-300 flex-shrink-0 border-r border-gray-200 dark:border-zinc-800`,children:e.jsx($e,{contacts:me,selectedContactId:s?.id,onSelectContact:a=>{const n=f.find(u=>u.id===a.id);x(n||null)},isLoading:w,emptyMessage:"Nenhuma conversa encontrada"})}),e.jsx("div",{className:"flex-1 flex flex-col bg-white dark:bg-zinc-900",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>l(!p),className:"lg:hidden p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",children:e.jsx(ee,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-semibold",children:s.contact_name?.[0]?.toUpperCase()||s.phone_number.slice(-2)}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:s.contact_name||s.phone_number}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-500 dark:text-zinc-400",children:s.phone_number}),_.has(s.id)&&e.jsx("span",{className:"text-violet-500 text-xs animate-pulse",children:"digitando..."})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium ${$?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"}`,children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${$?"bg-green-500 animate-pulse":"bg-red-500"}`}),$?"Online":"Offline"]}),e.jsx("button",{onClick:de,className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${s.mode==="human"?"bg-blue-100 text-blue-700 hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-400":"bg-green-100 text-green-700 hover:bg-green-200 dark:bg-green-900/30 dark:text-green-400"}`,children:s.mode==="human"?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4"})," Humano"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"w-4 h-4"})," Auto"]})}),e.jsx("button",{onClick:G,disabled:j,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-50",title:"Atualizar",children:e.jsx(_e,{className:`w-5 h-5 ${j?"animate-spin":""}`})})]})]}),Q&&e.jsxs("div",{className:"px-4 py-2 bg-yellow-50 dark:bg-yellow-900/20 border-b border-yellow-200 dark:border-yellow-800 flex items-center gap-2 text-yellow-700 dark:text-yellow-400 text-sm",children:[e.jsx(Se,{className:"w-4 h-4"}),Q]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0f2f5] dark:bg-zinc-950",children:[j?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-violet-500"})}):d.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(X,{className:"w-16 h-16 mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Nenhuma mensagem ainda"}),e.jsx("p",{className:"text-sm",children:"Envie a primeira mensagem!"})]}):Object.entries(ue).map(([a,n])=>e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("span",{className:"px-4 py-1.5 bg-white dark:bg-zinc-800 rounded-full text-xs text-gray-500 dark:text-zinc-400 shadow-sm",children:q(new Date(a),"d 'de' MMMM",{locale:V})})}),n.map(u=>e.jsx(De,{...Ue(u),onMediaClick:(b,E,C)=>R({url:b,type:E,fileName:C})},u.id))]},a)),e.jsx("div",{ref:y})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border-t border-gray-200 dark:border-zinc-800",children:[z&&e.jsxs("div",{className:"px-4 py-2 bg-violet-50 dark:bg-violet-900/20 flex items-center gap-2 text-violet-700 dark:text-violet-400",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-violet-500"}),e.jsx("span",{className:"text-sm",children:"Enviando arquivo..."})]}),e.jsx(Te,{onSend:le,onTyping:a=>s&&ae(s.id,a),disabled:!$||z,isLoading:M,showAttachment:!0,onAttachmentClick:()=>W.current?.click()}),e.jsx("input",{ref:W,type:"file",accept:"image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt",onChange:ce,className:"hidden"})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 p-8",children:[e.jsx("div",{className:"w-32 h-32 bg-gray-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mb-6",children:e.jsx(X,{className:"w-16 h-16 text-gray-300"})}),e.jsx("h3",{className:"text-xl font-medium text-gray-600 dark:text-gray-300 mb-2",children:"Selecione uma conversa"}),e.jsx("p",{className:"text-sm text-center max-w-md",children:"Escolha uma conversa da lista ao lado para comeÃ§ar a interagir com seus clientes"})]})}),h&&e.jsx(Fe,{url:h.url,type:h.type,fileName:h.fileName,onClose:()=>R(null)})]})};export{Je as C};
