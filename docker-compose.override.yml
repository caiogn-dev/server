# ============================================================================
# DOCKER COMPOSE OVERRIDE (Development)
# ============================================================================
# This file extends docker-compose.yml for local development
# It mounts source code for hot-reload and enables debug mode
# ============================================================================

version: '3.8'

services:
  web:
    build:
      target: production
    environment:
      - DEBUG=True
      - DJANGO_SETTINGS_MODULE=config.settings.development
    volumes:
      - ./:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:8000"
    # For Daphne (WebSocket support in dev):
    # command: >
    #   sh -c "python manage.py migrate &&
    #          daphne -b 0.0.0.0 -p 8000 config.asgi:application"

  celery:
    environment:
      - DEBUG=True
      - DJANGO_SETTINGS_MODULE=config.settings.development
    volumes:
      - ./:/app
      - logs_volume:/app/logs
    command: >
      watchmedo auto-restart
      --directory=/app
      --pattern=*.py
      --recursive
      -- celery -A config.celery worker -l info -Q whatsapp,orders,payments,langflow,automation,campaigns,messaging,default

  celery-beat:
    environment:
      - DEBUG=True
      - DJANGO_SETTINGS_MODULE=config.settings.development
    volumes:
      - ./:/app

  celery-langflow:
    environment:
      - DEBUG=True
      - DJANGO_SETTINGS_MODULE=config.settings.development
    volumes:
      - ./:/app

  # Optional: Flower for monitoring Celery
  flower:
    image: mher/flower:latest
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - FLOWER_PORT=5555
      - FLOWER_BASIC_AUTH=admin:admin
    ports:
      - "5555:5555"
    depends_on:
      - redis
      - celery
    networks:
      - pastita-network
